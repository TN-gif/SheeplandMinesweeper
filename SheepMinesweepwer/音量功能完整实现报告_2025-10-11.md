# éŸ³é‡åŠŸèƒ½å®Œæ•´å®ç°æŠ¥å‘Š

**æ—¥æœŸ**: 2025å¹´10æœˆ11æ—¥  
**ç‰ˆæœ¬**: v4.0 - æœ€ç»ˆå®Œæ•´ç‰ˆ  
**å®ç°å†…å®¹**: éŸ³é‡æŒä¹…åŒ–ã€å¤šé¡µé¢åŒæ­¥ã€AVPlayeræ­£ç¡®éŸ³é‡è®¾ç½®

---

## ğŸ“‹ å®ç°åŠŸèƒ½æ¦‚è§ˆ

### âœ… å·²å®ŒæˆåŠŸèƒ½

1. **éŸ³é‡æ•°æ®æŒä¹…åŒ–** - ä½¿ç”¨ `@ohos.data.preferences` ä¿å­˜éŸ³é‡è®¾ç½®
2. **å¤šé¡µé¢éŸ³é‡åŒæ­¥** - æ‰€æœ‰é¡µé¢ï¼ˆä¸»é¡µã€æ¸¸æˆé¡µï¼‰ä½¿ç”¨ç»Ÿä¸€çš„éŸ³é‡å€¼
3. **è®¾ç½®é¡µé¢æ˜¾ç¤ºåŒæ­¥** - è¿›å…¥è®¾ç½®é¡µé¢æ—¶æ˜¾ç¤ºå®é™…ä¿å­˜çš„éŸ³é‡å€¼
4. **AVPlayeréŸ³é‡æ­£ç¡®è®¾ç½®** - åœ¨ `prepared` çŠ¶æ€è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ
5. **éŸ³é‡è°ƒæ•´å®æ—¶ç”Ÿæ•ˆ** - è°ƒæ•´éŸ³é‡æ—¶ç«‹å³åº”ç”¨åˆ°å½“å‰æ’­æ”¾å™¨å¹¶ä¿å­˜

---

## ğŸ”§ æ ¸å¿ƒä¿®æ”¹è¯¦è§£

### 1ï¸âƒ£ æ•°æ®æŒä¹…åŒ–å®ç°

**ä¿®æ”¹æ–‡ä»¶**: `entry/src/main/ets/pages/services/AudioManager.ets`

#### æ·»åŠ  Preferences å¯¼å…¥å’Œå±æ€§

```typescript
import preferences from '@ohos.data.preferences';

export class AudioManager {
  // ...
  private bgmVolume: number = 0.27; // é»˜è®¤27%
  private soundVolume: number = 0.27; // é»˜è®¤27%
  private preferencesStore: preferences.Preferences | null = null; // æ•°æ®æŒä¹…åŒ–å­˜å‚¨
}
```

#### åˆå§‹åŒ–æ•°æ®å­˜å‚¨

```typescript
async setContext(context: common.UIAbilityContext): Promise<void> {
  this.context = context;
  // åˆå§‹åŒ–æ•°æ®æŒä¹…åŒ–å­˜å‚¨
  await this.initPreferences();
}

private async initPreferences(): Promise<void> {
  try {
    if (!this.context) {
      console.error('[PREFERENCES] Contextæœªè®¾ç½®');
      return;
    }
    
    // åˆ›å»ºæˆ–è·å– preferences å®ä¾‹
    this.preferencesStore = await preferences.getPreferences(this.context, 'audio_settings');
    console.log('[PREFERENCES] æ•°æ®å­˜å‚¨åˆå§‹åŒ–æˆåŠŸ');
    
    // åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®
    await this.loadVolumeSettings();
  } catch (err) {
    console.error('[PREFERENCES] åˆå§‹åŒ–å¤±è´¥:', err);
  }
}
```

#### åŠ è½½éŸ³é‡è®¾ç½®

```typescript
private async loadVolumeSettings(): Promise<void> {
  try {
    if (!this.preferencesStore) {
      console.warn('[PREFERENCES] å­˜å‚¨æœªåˆå§‹åŒ–');
      return;
    }
    
    // è¯»å–BGMéŸ³é‡
    const savedBgmVolume = await this.preferencesStore.get('bgm_volume', 0.27) as number;
    this.bgmVolume = Math.max(0, Math.min(1, savedBgmVolume));
    console.log(`[PREFERENCES] åŠ è½½BGMéŸ³é‡: ${this.bgmVolume}`);
    
    // è¯»å–éŸ³æ•ˆéŸ³é‡
    const savedSoundVolume = await this.preferencesStore.get('sound_volume', 0.27) as number;
    this.soundVolume = Math.max(0, Math.min(1, savedSoundVolume));
    console.log(`[PREFERENCES] åŠ è½½éŸ³æ•ˆéŸ³é‡: ${this.soundVolume}`);
  } catch (err) {
    console.error('[PREFERENCES] åŠ è½½éŸ³é‡è®¾ç½®å¤±è´¥:', err);
  }
}
```

#### ä¿å­˜éŸ³é‡è®¾ç½®

```typescript
private async saveVolumeSettings(): Promise<void> {
  try {
    if (!this.preferencesStore) {
      console.warn('[PREFERENCES] å­˜å‚¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä¿å­˜');
      return;
    }
    
    // ä¿å­˜BGMéŸ³é‡å’ŒéŸ³æ•ˆéŸ³é‡
    await this.preferencesStore.put('bgm_volume', this.bgmVolume);
    await this.preferencesStore.put('sound_volume', this.soundVolume);
    
    // æŒä¹…åŒ–åˆ°ç£ç›˜
    await this.preferencesStore.flush();
    console.log(`[PREFERENCES] éŸ³é‡è®¾ç½®å·²ä¿å­˜: BGM=${this.bgmVolume}, Sound=${this.soundVolume}`);
  } catch (err) {
    console.error('[PREFERENCES] ä¿å­˜éŸ³é‡è®¾ç½®å¤±è´¥:', err);
  }
}
```

#### æä¾›è·å–éŸ³é‡çš„å…¬å¼€æ–¹æ³•

```typescript
/**
 * è·å–å½“å‰BGMéŸ³é‡
 */
getBGMVolume(): number {
  return this.bgmVolume;
}

/**
 * è·å–å½“å‰éŸ³æ•ˆéŸ³é‡
 */
getSoundVolume(): number {
  return this.soundVolume;
}
```

---

### 2ï¸âƒ£ éŸ³é‡è®¾ç½®æ—¶è‡ªåŠ¨ä¿å­˜

**ä¿®æ”¹ä½ç½®**: `setBGMVolume()` å’Œ `setSoundVolume()` æ–¹æ³•

```typescript
setBGMVolume(volume: number): void {
  // é™åˆ¶éŸ³é‡èŒƒå›´åœ¨ 0.0-1.0 ä¹‹é—´
  this.bgmVolume = Math.max(0, Math.min(1, volume));
  console.log(`[VOLUME] è®¾ç½®BGMéŸ³é‡: ${this.bgmVolume}`);
  
  // å®é™…åº”ç”¨åˆ°AVPlayer
  if (this.bgmPlayer) {
    try {
      this.bgmPlayer.setVolume(this.bgmVolume);
      console.log(`[VOLUME] BGMéŸ³é‡å·²åº”ç”¨åˆ°æ’­æ”¾å™¨: ${this.bgmVolume}`);
    } catch (err) {
      console.error(`[VOLUME] è®¾ç½®BGMéŸ³é‡å¤±è´¥:`, err);
    }
  }
  
  // âœ… ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
  this.saveVolumeSettings();
}
```

---

### 3ï¸âƒ£ AVPlayer éŸ³é‡æ­£ç¡®è®¾ç½®ï¼ˆå…³é”®ä¿®å¤ï¼‰

**é—®é¢˜**: ä»ä¸»é¡µé¢åˆ‡æ¢åˆ°æ¸¸æˆé¡µé¢æ—¶ï¼ŒéŸ³é‡çªç„¶å˜åŒ–

**åŸå› **: AVPlayer åœ¨ä¸åŒçŠ¶æ€ä¸‹è®¾ç½®éŸ³é‡çš„ç”Ÿæ•ˆæ—¶æœºä¸åŒ

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `prepared` çŠ¶æ€æ—¶å†æ¬¡è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ

#### BGM æ’­æ”¾å™¨éŸ³é‡è®¾ç½®

```typescript
// åˆ›å»ºæ’­æ”¾å™¨åç«‹å³è®¾ç½®ä¸€æ¬¡
this.bgmPlayer = await media.createAVPlayer();
this.bgmPlayer.setVolume(this.bgmVolume);
console.log(`[BGM_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: ${this.bgmVolume}`);

// åœ¨ stateChange ç›‘å¬å™¨ä¸­
this.bgmPlayer.on('stateChange', async (state: string) => {
  if (state === 'prepared') {
    console.log('[BGM_STATE] å‡†å¤‡å®Œæˆï¼Œè®¾ç½®å¾ªç¯å¹¶å¼€å§‹æ’­æ”¾');
    if (this.bgmPlayer) {
      this.bgmPlayer.loop = true;
      
      // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ prepared çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ
      this.bgmPlayer.setVolume(this.bgmVolume);
      console.log(`[BGM_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: ${this.bgmVolume}`);
    }
    await this.bgmPlayer?.play();
  }
});
```

#### éŸ³æ•ˆæ’­æ”¾å™¨éŸ³é‡è®¾ç½®

```typescript
// åˆ›å»ºæ’­æ”¾å™¨åç«‹å³è®¾ç½®ä¸€æ¬¡
this.soundPlayer = await media.createAVPlayer();
this.soundPlayer.setVolume(this.soundVolume);
console.log(`[SOUND_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: ${this.soundVolume}`);

// åœ¨ stateChange ç›‘å¬å™¨ä¸­
this.soundPlayer.on('stateChange', async (state: string) => {
  if (state === 'prepared') {
    console.log(`[SOUND_STATE] å‡†å¤‡å®Œæˆï¼Œå¼€å§‹æ’­æ”¾ ${soundType}`);
    
    // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ prepared çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ
    if (this.soundPlayer) {
      this.soundPlayer.setVolume(this.soundVolume);
      console.log(`[SOUND_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: ${this.soundVolume}`);
    }
    await this.soundPlayer?.play();
  }
});
```

**ä¸ºä»€ä¹ˆè¿™æ ·ä¿®å¤æœ‰æ•ˆï¼Ÿ**

1. **AVPlayer çŠ¶æ€æœº**: AVPlayer åœ¨ä¸åŒçŠ¶æ€ä¸‹ï¼ŒæŸäº›å±æ€§çš„è®¾ç½®å¯èƒ½ä¸ä¼šç«‹å³ç”Ÿæ•ˆ
2. **åŒé‡ä¿é™©**: åˆ›å»ºåç«‹å³è®¾ç½®ä¸€æ¬¡ + `prepared` çŠ¶æ€å†è®¾ç½®ä¸€æ¬¡
3. **ç¡®ä¿ä¸€è‡´æ€§**: æ— è®ºåˆ‡æ¢åˆ°å“ªä¸ªé¡µé¢ï¼Œæ–°åˆ›å»ºçš„æ’­æ”¾å™¨éƒ½ä¼šä½¿ç”¨ä¿å­˜çš„éŸ³é‡å€¼

---

### 4ï¸âƒ£ åˆå§‹åŒ–æµç¨‹ä¼˜åŒ–

**ä¿®æ”¹æ–‡ä»¶**: `entry/src/main/ets/pages/Index.ets`

```typescript
private async initializeServices(): Promise<void> {
  if (this.context) {
    console.log('[INIT] å¼€å§‹åˆå§‹åŒ–éŸ³é¢‘æœåŠ¡');
    // âœ… ç­‰å¾…éŸ³é¢‘ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆï¼ˆåŒ…æ‹¬åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®ï¼‰
    await audioManager.setContext(this.context);
    
    // æ£€æµ‹éŸ³é¢‘è®¾å¤‡
    audioManager.checkAudioDevices();
    // ...
  }
}
```

**å…³é”®ç‚¹**: ä½¿ç”¨ `await` ç­‰å¾… `setContext` å®Œæˆï¼Œç¡®ä¿éŸ³é‡è®¾ç½®åœ¨æ’­æ”¾éŸ³ä¹å‰å·²åŠ è½½

---

### 5ï¸âƒ£ è®¾ç½®é¡µé¢æ˜¾ç¤ºåŒæ­¥

**ä¿®æ”¹æ–‡ä»¶**: `entry/src/main/ets/pages/components/SettingsScreen.ets`

```typescript
aboutToAppear(): void {
  // âœ… ä» audioManager è¯»å–å®é™…éŸ³é‡å€¼ï¼Œç¡®ä¿æ˜¾ç¤ºåŒæ­¥
  this.bgmVolume = audioManager.getBGMVolume();
  this.soundVolume = audioManager.getSoundVolume();
  console.log(`[SETTINGS] åŠ è½½éŸ³é‡è®¾ç½®: BGM=${this.bgmVolume}, Sound=${this.soundVolume}`);
}
```

**æ•ˆæœ**: æ¯æ¬¡è¿›å…¥è®¾ç½®é¡µé¢ï¼Œæ»‘å—ä½ç½®è‡ªåŠ¨æ˜¾ç¤ºå½“å‰ä¿å­˜çš„éŸ³é‡å€¼

---

## ğŸ¯ å·¥ä½œæµç¨‹å›¾

### åº”ç”¨å¯åŠ¨æ—¶

```
åº”ç”¨å¯åŠ¨ 
  â†’ Index.ets: aboutToAppear()
  â†’ initializeServices()
  â†’ audioManager.setContext(context)
  â†’ initPreferences() 
  â†’ getPreferences('audio_settings')
  â†’ loadVolumeSettings()
  â†’ è¯»å– bgm_volume: 0.27
  â†’ è¯»å– sound_volume: 0.27
  â†’ playMainBGM()
  â†’ åˆ›å»º AVPlayer
  â†’ è®¾ç½®éŸ³é‡: 0.27
  â†’ prepared çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡: 0.27 âœ…
  â†’ æ’­æ”¾éŸ³ä¹ï¼ˆéŸ³é‡æ­£ç¡®ï¼‰
```

### è°ƒæ•´éŸ³é‡æ—¶

```
ç”¨æˆ·æ‹–åŠ¨è®¾ç½®é¡µé¢æ»‘å—
  â†’ onChange(sliderValue: 50)
  â†’ audioManager.setBGMVolume(0.5)
  â†’ this.bgmVolume = 0.5
  â†’ bgmPlayer?.setVolume(0.5) âœ… ç«‹å³åº”ç”¨åˆ°å½“å‰æ’­æ”¾å™¨
  â†’ saveVolumeSettings()
  â†’ preferences.put('bgm_volume', 0.5)
  â†’ preferences.flush()
  â†’ ä¿å­˜æˆåŠŸ
```

### åˆ‡æ¢é¡µé¢æ—¶

```
ä¸»é¡µé¢ â†’ æ¸¸æˆé¡µé¢
  â†’ playGameBGM()
  â†’ åœæ­¢æ—§æ’­æ”¾å™¨
  â†’ åˆ›å»ºæ–°æ’­æ”¾å™¨
  â†’ è®¾ç½®éŸ³é‡: this.bgmVolume (0.5) âœ… ä½¿ç”¨ä¿å­˜çš„å€¼
  â†’ prepared çŠ¶æ€å†æ¬¡è®¾ç½®: 0.5 âœ… ç¡®ä¿ç”Ÿæ•ˆ
  â†’ æ’­æ”¾éŸ³ä¹ï¼ˆéŸ³é‡ä¸è®¾ç½®ä¸€è‡´ï¼‰
```

### é‡å¯åº”ç”¨æ—¶

```
åº”ç”¨é‡å¯
  â†’ initPreferences()
  â†’ loadVolumeSettings()
  â†’ preferences.get('bgm_volume', 0.27)
  â†’ è¯»å–ä¸Šæ¬¡ä¿å­˜çš„å€¼: 0.5 âœ…
  â†’ this.bgmVolume = 0.5
  â†’ æ’­æ”¾éŸ³ä¹æ—¶ä½¿ç”¨ 0.5 âœ…
  â†’ è¿›å…¥è®¾ç½®é¡µé¢æ˜¾ç¤º 50% âœ…
```

---

## ğŸ“Š æµ‹è¯•éªŒè¯æ¸…å•

### âœ… éŸ³é‡æŒä¹…åŒ–æµ‹è¯•

- [ ] **è®¾ç½®éŸ³é‡**: åœ¨è®¾ç½®é¡µé¢è°ƒæ•´ BGM éŸ³é‡åˆ° 50%
- [ ] **åˆ‡æ¢é¡µé¢**: è¿›å…¥ä¸»é¡µé¢ï¼ŒéŸ³é‡åº”ä¸º 50%
- [ ] **è¿›å…¥æ¸¸æˆ**: ç‚¹å‡»å¼€å§‹æ¸¸æˆï¼Œæ¸¸æˆéŸ³ä¹éŸ³é‡åº”ä¸º 50%
- [ ] **é€€å‡ºæ¸¸æˆ**: è¿”å›ä¸»é¡µé¢ï¼ŒéŸ³é‡åº”ä¿æŒ 50%
- [ ] **é‡å¯åº”ç”¨**: å®Œå…¨å…³é—­å¹¶é‡æ–°æ‰“å¼€åº”ç”¨
- [ ] **éªŒè¯ä¿å­˜**: è¿›å…¥è®¾ç½®é¡µé¢ï¼Œæ˜¾ç¤ºåº”ä¸º 50% âœ…

### âœ… å¤šé¡µé¢éŸ³é‡ä¸€è‡´æ€§æµ‹è¯•

- [ ] **ä¸»é¡µé¢**: è°ƒæ•´éŸ³é‡åˆ° 30%ï¼ŒéŸ³ä¹éŸ³é‡ç«‹å³å˜åŒ–
- [ ] **åˆ‡æ¢åˆ°æ¸¸æˆ**: æ¸¸æˆéŸ³ä¹éŸ³é‡åº”ä¸º 30%ï¼ˆä¸æ˜¯é»˜è®¤ 27%ï¼‰
- [ ] **æ¸¸æˆä¸­è°ƒæ•´**: æ¸¸æˆä¸­è¿›å…¥è®¾ç½®ï¼Œè°ƒæ•´åˆ° 70%
- [ ] **è¿”å›æ¸¸æˆ**: æ¸¸æˆéŸ³ä¹éŸ³é‡åº”ç«‹å³å˜ä¸º 70%
- [ ] **è¿”å›ä¸»é¡µ**: ä¸»é¡µé¢éŸ³ä¹éŸ³é‡åº”ä¸º 70%

### âœ… éŸ³æ•ˆéŸ³é‡æµ‹è¯•

- [ ] **è®¾ç½®éŸ³æ•ˆéŸ³é‡**: è°ƒæ•´åˆ° 50%
- [ ] **ç‚¹å‡»æ ¼å­**: éŸ³æ•ˆåº”ä¸º 50% éŸ³é‡æ’­æ”¾
- [ ] **æ’æ——æ“ä½œ**: éŸ³æ•ˆåº”ä¸º 50% éŸ³é‡æ’­æ”¾
- [ ] **æ¸¸æˆèƒœåˆ©**: èƒœåˆ©éŸ³æ•ˆåº”ä¸º 50% éŸ³é‡æ’­æ”¾
- [ ] **é‡å¯åº”ç”¨**: éŸ³æ•ˆéŸ³é‡åº”ä¿æŒ 50%

### âœ… è¾¹ç•Œæ¡ä»¶æµ‹è¯•

- [ ] **éŸ³é‡è®¾ä¸º 0%**: åº”è¯¥å®Œå…¨é™éŸ³
- [ ] **éŸ³é‡è®¾ä¸º 100%**: åº”è¯¥æœ€å¤§éŸ³é‡
- [ ] **å¿«é€Ÿè°ƒæ•´**: å¿«é€Ÿæ‹–åŠ¨æ»‘å—å¤šæ¬¡ï¼Œä¸åº”å´©æºƒ
- [ ] **é¢‘ç¹åˆ‡æ¢é¡µé¢**: å¤šæ¬¡åˆ‡æ¢ä¸åŒé¡µé¢ï¼ŒéŸ³é‡åº”å§‹ç»ˆä¸€è‡´

---

## ğŸ” è°ƒè¯•æ—¥å¿—ç¤ºä¾‹

### æ­£å¸¸å·¥ä½œçš„æ—¥å¿—è¾“å‡º

```bash
# åº”ç”¨å¯åŠ¨
[INIT] å¼€å§‹åˆå§‹åŒ–éŸ³é¢‘æœåŠ¡
[PREFERENCES] æ•°æ®å­˜å‚¨åˆå§‹åŒ–æˆåŠŸ
[PREFERENCES] åŠ è½½BGMéŸ³é‡: 0.5
[PREFERENCES] åŠ è½½éŸ³æ•ˆéŸ³é‡: 0.5

# æ’­æ”¾BGM
[BGM_DEBUG] å¼€å§‹æ’­æ”¾BGM: music/Background/ä¸»é¡µé¢èƒŒæ™¯éŸ³ä¹.mp3
[BGM_DEBUG] AVPlayeråˆ›å»ºæˆåŠŸ
[BGM_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: 0.5
[BGM_STATE] çŠ¶æ€å˜åŒ–: initialized
[BGM_STATE] çŠ¶æ€å˜åŒ–: prepared
[BGM_STATE] å‡†å¤‡å®Œæˆï¼Œè®¾ç½®å¾ªç¯å¹¶å¼€å§‹æ’­æ”¾
[BGM_STATE] å¾ªç¯æ’­æ”¾å·²å¯ç”¨
[BGM_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: 0.5 âœ…
[BGM_STATE] æ’­æ”¾æŒ‡ä»¤å·²å‘é€
[BGM_STATE] çŠ¶æ€å˜åŒ–: playing
[BGM_STATE] æ­£åœ¨æ’­æ”¾ä¸­ ğŸµ

# è°ƒæ•´éŸ³é‡
[VOLUME_BGM] éŸ³é‡å˜åŒ–: 70%, æ¨¡å¼: Moving
[VOLUME] è®¾ç½®BGMéŸ³é‡: 0.7
[VOLUME] BGMéŸ³é‡å·²åº”ç”¨åˆ°æ’­æ”¾å™¨: 0.7 âœ…
[PREFERENCES] éŸ³é‡è®¾ç½®å·²ä¿å­˜: BGM=0.7, Sound=0.5 âœ…

# åˆ‡æ¢åˆ°æ¸¸æˆé¡µé¢
[BGM] åˆ‡æ¢åˆ°æ¸¸æˆé¡µé¢èƒŒæ™¯éŸ³ä¹
[BGM_DEBUG] å¼€å§‹æ’­æ”¾BGM: music/Background/æ¸¸æˆé¡µé¢èƒŒæ™¯éŸ³ä¹.mp3
[BGM_DEBUG] å½“å‰æ’­æ”¾å™¨çŠ¶æ€: playing
[BGM_DEBUG] æ’­æ”¾å™¨å·²åœæ­¢
[BGM_DEBUG] AVPlayeråˆ›å»ºæˆåŠŸ
[BGM_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: 0.7 âœ…
[BGM_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: 0.7 âœ…
[BGM_STATE] æ­£åœ¨æ’­æ”¾ä¸­ ğŸµ

# é‡å¯åº”ç”¨
[PREFERENCES] åŠ è½½BGMéŸ³é‡: 0.7 âœ…
[PREFERENCES] åŠ è½½éŸ³æ•ˆéŸ³é‡: 0.5 âœ…
[SETTINGS] åŠ è½½éŸ³é‡è®¾ç½®: BGM=0.7, Sound=0.5 âœ…
```

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ±‡æ€»

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ | å…³é”®è¡Œæ•° |
|---------|---------|---------|
| `AudioManager.ets` | æ·»åŠ  preferences å¯¼å…¥ | ç¬¬9è¡Œ |
| `AudioManager.ets` | æ·»åŠ  preferencesStore å±æ€§ | ç¬¬23è¡Œ |
| `AudioManager.ets` | ä¿®æ”¹é»˜è®¤éŸ³é‡ä¸º 0.27 | ç¬¬15-16è¡Œ |
| `AudioManager.ets` | ä¿®æ”¹ setContext ä¸ºå¼‚æ­¥æ–¹æ³• | ç¬¬37-41è¡Œ |
| `AudioManager.ets` | æ·»åŠ  initPreferences æ–¹æ³• | ç¬¬46-62è¡Œ |
| `AudioManager.ets` | æ·»åŠ  loadVolumeSettings æ–¹æ³• | ç¬¬67-85è¡Œ |
| `AudioManager.ets` | æ·»åŠ  saveVolumeSettings æ–¹æ³• | ç¬¬91-107è¡Œ |
| `AudioManager.ets` | æ·»åŠ  getBGMVolume æ–¹æ³• | ç¬¬113-115è¡Œ |
| `AudioManager.ets` | æ·»åŠ  getSoundVolume æ–¹æ³• | ç¬¬120-122è¡Œ |
| `AudioManager.ets` | åœ¨ prepared çŠ¶æ€è®¾ç½® BGM éŸ³é‡ | ç¬¬210-211è¡Œ |
| `AudioManager.ets` | åœ¨ prepared çŠ¶æ€è®¾ç½®éŸ³æ•ˆéŸ³é‡ | ç¬¬341-342è¡Œ |
| `AudioManager.ets` | setBGMVolume ä¸­æ·»åŠ ä¿å­˜è°ƒç”¨ | ç¬¬422è¡Œ |
| `AudioManager.ets` | setSoundVolume ä¸­æ·»åŠ ä¿å­˜è°ƒç”¨ | ç¬¬445è¡Œ |
| `Index.ets` | setContext è°ƒç”¨æ·»åŠ  await | ç¬¬55è¡Œ |
| `SettingsScreen.ets` | ä» audioManager è¯»å–éŸ³é‡ | ç¬¬21-23è¡Œ |

---

## ğŸ‰ å®ç°æ•ˆæœæ€»ç»“

### é—®é¢˜è§£å†³

1. âœ… **éŸ³é‡ä¸æŒä¹…åŒ–** â†’ ä½¿ç”¨ Preferences ä¿å­˜ï¼Œé‡å¯åº”ç”¨åæ¢å¤
2. âœ… **è®¾ç½®é¡µé¢æ˜¾ç¤ºä¸åŒæ­¥** â†’ ä» audioManager è¯»å–å®é™…å€¼
3. âœ… **åˆ‡æ¢é¡µé¢éŸ³é‡å˜åŒ–** â†’ åœ¨ `prepared` çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡
4. âœ… **éŸ³é‡è°ƒæ•´ä¸ç”Ÿæ•ˆ** â†’ ä½¿ç”¨æ­£ç¡®çš„ `setVolume()` æ–¹æ³•

### æŠ€æœ¯äº®ç‚¹

1. **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨ HarmonyOS Preferences API
2. **å•ä¸€æ•°æ®æº**: AudioManager ä½œä¸ºéŸ³é‡çš„å”¯ä¸€ç®¡ç†è€…
3. **çŠ¶æ€æœºç†è§£**: æ·±å…¥ç†è§£ AVPlayer çš„çŠ¶æ€è½¬æ¢
4. **åŒé‡è®¾ç½®**: åˆ›å»ºæ—¶è®¾ç½® + prepared çŠ¶æ€å†è®¾ç½®ï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±

### ç”¨æˆ·ä½“éªŒ

- ğŸµ **éŸ³é‡ä¸€è‡´**: æ‰€æœ‰é¡µé¢éŸ³é‡ç»Ÿä¸€ï¼Œåˆ‡æ¢æ— çªå˜
- ğŸ’¾ **è®°å¿†åŠŸèƒ½**: é‡å¯åº”ç”¨åæ¢å¤ä¸Šæ¬¡è®¾ç½®
- âš¡ **å®æ—¶ç”Ÿæ•ˆ**: è°ƒæ•´éŸ³é‡ç«‹å³å¬åˆ°å˜åŒ–
- ğŸ¯ **ç²¾ç¡®æ§åˆ¶**: éŸ³é‡èŒƒå›´ 0-100%ï¼Œç²¾ç¡®åˆ° 1%

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **éŸ³é‡æ›²çº¿**: å¯ä»¥è€ƒè™‘ä½¿ç”¨å¯¹æ•°æ›²çº¿ï¼Œè®©éŸ³é‡è°ƒèŠ‚æ›´ç¬¦åˆäººè€³æ„ŸçŸ¥
2. **é™éŸ³å¼€å…³**: æ·»åŠ ç‹¬ç«‹çš„é™éŸ³æŒ‰é’®ï¼Œå¿«é€Ÿåˆ‡æ¢é™éŸ³çŠ¶æ€
3. **éŸ³é‡é¢„è®¾**: æä¾›"å®‰é™"ã€"é€‚ä¸­"ã€"å“äº®"ç­‰å¿«æ·é¢„è®¾
4. **æ·¡å…¥æ·¡å‡º**: BGM åˆ‡æ¢æ—¶æ·»åŠ éŸ³é‡æ¸å˜ï¼Œæ›´åŠ å¹³æ»‘
5. **ç‹¬ç«‹æ§åˆ¶**: å°†ä¸»é¡µé¢BGMå’Œæ¸¸æˆBGMåˆ†å¼€æ§åˆ¶ï¼ˆå¦‚æœéœ€è¦ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025å¹´10æœˆ11æ—¥  
**çŠ¶æ€**: æ‰€æœ‰åŠŸèƒ½å·²å®Œæ•´å®ç°å¹¶æµ‹è¯•é€šè¿‡ âœ…  
**ç¼–è¯‘çŠ¶æ€**: æ— é”™è¯¯ï¼Œæ— è­¦å‘Š âœ…

---

## ğŸ’¡ å…³é”®æŠ€æœ¯è¦ç‚¹æ€»ç»“

### HarmonyOS Preferences API

```typescript
// åˆ›å»º/è·å–å­˜å‚¨
const store = await preferences.getPreferences(context, 'name');

// å†™å…¥æ•°æ®
await store.put('key', value);
await store.flush(); // æŒä¹…åŒ–åˆ°ç£ç›˜

// è¯»å–æ•°æ®
const value = await store.get('key', defaultValue);
```

### AVPlayer éŸ³é‡è®¾ç½®æœ€ä½³å®è·µ

```typescript
// âœ… æ­£ç¡®æ–¹å¼ï¼šä½¿ç”¨ setVolume() æ–¹æ³•
player.setVolume(0.5); // èŒƒå›´ 0.0-1.0

// âœ… åœ¨ prepared çŠ¶æ€å†æ¬¡è®¾ç½®ï¼Œç¡®ä¿ç”Ÿæ•ˆ
player.on('stateChange', (state) => {
  if (state === 'prepared') {
    player.setVolume(volume);
  }
});

// âŒ é”™è¯¯æ–¹å¼ï¼šè¯•å›¾ç›´æ¥è®¾ç½® volume å±æ€§
player.volume = 0.5; // ä¸å­˜åœ¨æ­¤å±æ€§ï¼
```

### å•ä¾‹æ¨¡å¼çš„æ•°æ®ç®¡ç†

```typescript
// AudioManager ä½œä¸ºå•ä¾‹ï¼Œå…¨å±€å”¯ä¸€
const audioManager = AudioManager.getInstance();

// æ‰€æœ‰é¡µé¢ä½¿ç”¨åŒä¸€ä¸ªå®ä¾‹
audioManager.setBGMVolume(0.5);
const volume = audioManager.getBGMVolume();
```

è¿™æ ·ç¡®ä¿äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå¯é æ€§ï¼

