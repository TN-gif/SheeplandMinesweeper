/**
 * è®¾ç½®ç•Œé¢
 * å…è®¸ç”¨æˆ·è°ƒæ•´éŸ³æ•ˆã€éœ‡åŠ¨ç­‰è®¾ç½®
 */
import { ThemeProvider, themeProvider } from '../theme/ThemeProvider';
import { audioManager } from '../services/AudioManager';
import { HapticFeedbackUtils } from '../utils/HapticFeedbackUtils';

@Component
export struct SettingsScreen {
  @ObjectLink provider: ThemeProvider;
  @State bgmEnabled: boolean = true;
  @State soundEnabled: boolean = true;
  @State hapticEnabled: boolean = true;
  @State bgmVolume: number = 0.5;
  @State soundVolume: number = 0.7;
  onBack: () => void = () => {};

  aboutToAppear(): void {
    // ä»AudioManagerè·å–å½“å‰è®¾ç½®
    this.bgmEnabled = true; // é»˜è®¤å€¼ï¼Œå®é™…åº”è¯¥ä»å­˜å‚¨ä¸­è¯»å–
    this.soundEnabled = true;
    this.hapticEnabled = true;
    this.bgmVolume = 0.5;
    this.soundVolume = 0.7;
  }

  private async playBGMSafely(): Promise<void> {
    try {
      await audioManager.playBGM(this.provider.currentTheme.audio.bgm);
    } catch (error) {
      console.error('Failed to play BGM:', error);
    }
  }

  build() {
    Column() {
      // æ ‡é¢˜
      Text('âš™ï¸ æ¸¸æˆè®¾ç½® âš™ï¸')
        .fontSize(40)
        .fontWeight(FontWeight.Bold)
        .fontColor(this.provider.currentTheme.colors.textPrimary)
        .margin({ top: 40, bottom: 30 })
        .textShadow({ radius: 3, color: '#00000030', offsetX: 2, offsetY: 2 });

      // è®¾ç½®é€‰é¡¹åˆ—è¡¨
      Column({ space: 20 }) {
        // èƒŒæ™¯éŸ³ä¹è®¾ç½®
        this.SettingCard('ğŸµ èƒŒæ™¯éŸ³ä¹', () => {
          this.bgmEnabled = !this.bgmEnabled;
          audioManager.setBGMEnabled(this.bgmEnabled);
          if (this.bgmEnabled) {
            this.playBGMSafely();
          }
        }, this.bgmEnabled);

        // éŸ³æ•ˆè®¾ç½®
        this.SettingCard('ğŸ”Š æ¸¸æˆéŸ³æ•ˆ', () => {
          this.soundEnabled = !this.soundEnabled;
          audioManager.setSoundEnabled(this.soundEnabled);
        }, this.soundEnabled);

        // è§¦è§‰åé¦ˆè®¾ç½®
        this.SettingCard('ğŸ“³ éœ‡åŠ¨åé¦ˆ', () => {
          this.hapticEnabled = !this.hapticEnabled;
          HapticFeedbackUtils.setEnabled(this.hapticEnabled);
          if (this.hapticEnabled) {
            HapticFeedbackUtils.vibrate('light');
          }
        }, this.hapticEnabled);

        // éŸ³é‡æ»‘å—
        this.VolumeSlider('ğŸµ èƒŒæ™¯éŸ³ä¹éŸ³é‡', this.bgmVolume, (value: number) => {
          this.bgmVolume = value;
          audioManager.setBGMVolume(value);
        });

        this.VolumeSlider('ğŸ”Š éŸ³æ•ˆéŸ³é‡', this.soundVolume, (value: number) => {
          this.soundVolume = value;
          audioManager.setSoundVolume(value);
        });
      }
      .width('90%')
      .padding({ bottom: 40 });

      // è¿”å›æŒ‰é’®
      Button('è¿”å›èœå•')
        .width('85%')
        .height(55)
        .fontSize(20)
        .fontWeight(FontWeight.Medium)
        .backgroundColor('#FF9800')
        .borderRadius(15)
        .shadow({ radius: 8, color: '#00000030', offsetX: 0, offsetY: 4 })
        .margin({ top: 20, bottom: 30 })
        .onClick(this.onBack);
    }
    .width('100%')
    .height('100%')
    .backgroundImage(this.provider.currentTheme.assets.background)
    .backgroundImageSize(ImageSize.Cover);
  }

  @Builder
  SettingCard(title: string, onToggle: () => void, isEnabled: boolean) {
    Row() {
      Text(title)
        .fontSize(22)
        .fontWeight(FontWeight.Medium)
        .fontColor(this.provider.currentTheme.colors.textPrimary)
        .layoutWeight(1);

      // å¼€å…³æŒ‰é’®
      Button(isEnabled ? 'å¼€å¯' : 'å…³é—­')
        .width(80)
        .height(40)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .backgroundColor(isEnabled ? 
          this.provider.currentTheme.colors.primary : 
          '#D0D0D0')
        .fontColor('#FFFFFF')
        .borderRadius(20)
        .onClick(() => {
          onToggle();
        });
    }
    .width('100%')
    .padding(20)
    .backgroundColor(this.provider.currentTheme.colors.cardBg)
    .borderRadius(15)
    .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 });
  }

  @Builder
  VolumeSlider(title: string, value: number, onValueChange: (value: number) => void) {
    Column({ space: 10 }) {
      Row() {
        Text(title)
          .fontSize(20)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.provider.currentTheme.colors.textPrimary);
        
        Blank();
        
        Text(`${Math.round(value * 100)}%`)
          .fontSize(16)
          .fontColor(this.provider.currentTheme.colors.textSecondary);
      }
      .width('100%');

      Slider({
        value: value * 100,
        min: 0,
        max: 100,
        step: 10,
        style: SliderStyle.OutSet
      })
        .trackColor('#E0E0E0')
        .selectedColor(this.provider.currentTheme.colors.primary)
        .blockColor(this.provider.currentTheme.colors.primary)
        .width('100%')
        .onChange((value: number, mode: SliderChangeMode) => {
          if (mode === SliderChangeMode.End || mode === SliderChangeMode.Moving) {
            onValueChange(value / 100);
          }
        });
    }
    .width('100%')
    .padding(20)
    .backgroundColor(this.provider.currentTheme.colors.cardBg)
    .borderRadius(15)
    .shadow({ radius: 8, color: '#00000020', offsetX: 0, offsetY: 4 });
  }
}
