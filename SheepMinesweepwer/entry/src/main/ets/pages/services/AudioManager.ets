/**
 * éŸ³é¢‘ç®¡ç†å™¨
 * è´Ÿè´£æ’­æ”¾èƒŒæ™¯éŸ³ä¹å’ŒéŸ³æ•ˆ
 */
import media from '@ohos.multimedia.media';
import common from '@ohos.app.ability.common';
import audio from '@ohos.multimedia.audio';
import resourceManager from '@ohos.resourceManager';
import preferences from '@ohos.data.preferences';

export class AudioManager {
  private static instance: AudioManager;
  private bgmPlayer: media.AVPlayer | null = null;
  private soundPlayer: media.AVPlayer | null = null;
  private bgmVolume: number = 0.27; // é»˜è®¤27%
  private soundVolume: number = 0.27; // é»˜è®¤27%
  private bgmEnabled: boolean = true;
  private soundEnabled: boolean = true;
  private context?: common.UIAbilityContext;
  private currentBGMFd: resourceManager.RawFileDescriptor | null = null;
  private currentSoundFd: resourceManager.RawFileDescriptor | null = null;
  private currentBGMPath: string = ''; // è·Ÿè¸ªå½“å‰æ’­æ”¾çš„BGMè·¯å¾„
  private preferencesStore: preferences.Preferences | null = null; // æ•°æ®æŒä¹…åŒ–å­˜å‚¨

  private constructor() {}

  static getInstance(): AudioManager {
    if (!AudioManager.instance) {
      AudioManager.instance = new AudioManager();
    }
    return AudioManager.instance;
  }

  /**
   * è®¾ç½®Contextï¼ˆå¿…é¡»åœ¨ä½¿ç”¨å‰è°ƒç”¨ï¼‰
   */
  async setContext(context: common.UIAbilityContext): Promise<void> {
    this.context = context;
    // åˆå§‹åŒ–æ•°æ®æŒä¹…åŒ–å­˜å‚¨
    await this.initPreferences();
  }

  /**
   * åˆå§‹åŒ–æ•°æ®æŒä¹…åŒ–
   */
  private async initPreferences(): Promise<void> {
    try {
      if (!this.context) {
        console.error('[PREFERENCES] Contextæœªè®¾ç½®');
        return;
      }
      
      // åˆ›å»ºæˆ–è·å– preferences å®ä¾‹
      this.preferencesStore = await preferences.getPreferences(this.context, 'audio_settings');
      console.log('[PREFERENCES] æ•°æ®å­˜å‚¨åˆå§‹åŒ–æˆåŠŸ');
      
      // åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®
      await this.loadVolumeSettings();
    } catch (err) {
      console.error('[PREFERENCES] åˆå§‹åŒ–å¤±è´¥:', err);
    }
  }

  /**
   * åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®
   */
  private async loadVolumeSettings(): Promise<void> {
    try {
      if (!this.preferencesStore) {
        console.warn('[PREFERENCES] å­˜å‚¨æœªåˆå§‹åŒ–');
        return;
      }
      
      // è¯»å–BGMéŸ³é‡
      const savedBgmVolume = await this.preferencesStore.get('bgm_volume', 0.27) as number;
      this.bgmVolume = Math.max(0, Math.min(1, savedBgmVolume));
      console.log(`[PREFERENCES] åŠ è½½BGMéŸ³é‡: ${this.bgmVolume}`);
      
      // è¯»å–éŸ³æ•ˆéŸ³é‡
      const savedSoundVolume = await this.preferencesStore.get('sound_volume', 0.27) as number;
      this.soundVolume = Math.max(0, Math.min(1, savedSoundVolume));
      console.log(`[PREFERENCES] åŠ è½½éŸ³æ•ˆéŸ³é‡: ${this.soundVolume}`);
    } catch (err) {
      console.error('[PREFERENCES] åŠ è½½éŸ³é‡è®¾ç½®å¤±è´¥:', err);
    }
  }

  /**
   * ä¿å­˜éŸ³é‡è®¾ç½®åˆ°æŒä¹…åŒ–å­˜å‚¨
   */
  private async saveVolumeSettings(): Promise<void> {
    try {
      if (!this.preferencesStore) {
        console.warn('[PREFERENCES] å­˜å‚¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä¿å­˜');
        return;
      }
      
      // ä¿å­˜BGMéŸ³é‡
      await this.preferencesStore.put('bgm_volume', this.bgmVolume);
      await this.preferencesStore.put('sound_volume', this.soundVolume);
      
      // æŒä¹…åŒ–åˆ°ç£ç›˜
      await this.preferencesStore.flush();
      console.log(`[PREFERENCES] éŸ³é‡è®¾ç½®å·²ä¿å­˜: BGM=${this.bgmVolume}, Sound=${this.soundVolume}`);
    } catch (err) {
      console.error('[PREFERENCES] ä¿å­˜éŸ³é‡è®¾ç½®å¤±è´¥:', err);
    }
  }

  /**
   * è·å–å½“å‰BGMéŸ³é‡
   */
  getBGMVolume(): number {
    return this.bgmVolume;
  }

  /**
   * è·å–å½“å‰éŸ³æ•ˆéŸ³é‡
   */
  getSoundVolume(): number {
    return this.soundVolume;
  }

  /**
   * æ£€æµ‹éŸ³é¢‘è®¾å¤‡ï¼ˆç®€åŒ–ç‰ˆï¼‰
   */
  checkAudioDevices(): void {
    // ç®€åŒ–ï¼šä»…è¾“å‡ºæ—¥å¿—ï¼Œä¸å®é™…æ£€æµ‹è®¾å¤‡
    // é¿å…ä½¿ç”¨å¯èƒ½ä¸å­˜åœ¨çš„ API
    console.log('[AUDIO_DEBUG] éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–ä¸­...');
  }

  /**
   * æ’­æ”¾èƒŒæ™¯éŸ³ä¹
   */
  async playBGM(resourcePath: string): Promise<void> {
    if (!this.bgmEnabled || !this.context) {
      console.log('[BGM_DEBUG] BGM disabled or no context');
      return;
    }

    try {
      console.log(`[BGM_DEBUG] å¼€å§‹æ’­æ”¾BGM: ${resourcePath}`);
      
      // âœ… æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æ’­æ”¾åŒæ ·çš„BGM
      if (this.currentBGMPath === resourcePath && this.bgmPlayer && this.bgmPlayer.state === 'playing') {
        console.log('[BGM_DEBUG] å·²åœ¨æ’­æ”¾ç›¸åŒBGMï¼Œè·³è¿‡é‡å¤æ’­æ”¾');
        return;
      }
      
      // åœæ­¢å½“å‰BGMï¼ˆå¢åŠ çŠ¶æ€æ ¡éªŒï¼‰
      if (this.bgmPlayer) {
        try {
          const currentState = this.bgmPlayer.state;
          console.log(`[BGM_DEBUG] å½“å‰æ’­æ”¾å™¨çŠ¶æ€: ${currentState}`);
          
          // åªåœ¨æ’­æ”¾å™¨å¤„äºå¯åœæ­¢çŠ¶æ€æ—¶è°ƒç”¨ stop
          if (currentState === 'playing' || currentState === 'paused' || 
              currentState === 'prepared' || currentState === 'completed') {
            await this.bgmPlayer.stop();
            console.log('[BGM_DEBUG] æ’­æ”¾å™¨å·²åœæ­¢');
          }
          
          await this.bgmPlayer.release();
          console.log('[BGM_DEBUG] BGMæ’­æ”¾å™¨å·²é‡Šæ”¾');
        } catch (e) {
          console.log('[BGM_DEBUG] Error stopping BGM:', e);
        }
        this.bgmPlayer = null;
        this.currentBGMFd = null;
        this.currentBGMPath = ''; // æ¸…é™¤å½“å‰BGMè·¯å¾„
      }

      // åˆ›å»ºæ–°çš„æ’­æ”¾å™¨
      this.bgmPlayer = await media.createAVPlayer();
      console.log('[BGM_DEBUG] AVPlayeråˆ›å»ºæˆåŠŸ');
      
      // âœ… è®¾ç½®åˆå§‹éŸ³é‡ï¼ˆä½¿ç”¨setVolumeæ–¹æ³•ï¼‰
      this.bgmPlayer.setVolume(this.bgmVolume);
      console.log(`[BGM_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: ${this.bgmVolume}`);
      
      // è®¾ç½®çŠ¶æ€å˜åŒ–ç›‘å¬å™¨ï¼ˆå¿…é¡»åœ¨è®¾ç½®fdSrcä¹‹å‰ï¼‰
      this.bgmPlayer.on('stateChange', async (state: string) => {
        console.log(`[BGM_STATE] çŠ¶æ€å˜åŒ–: ${state}`);
        
        if (state === 'error') {
          console.error(`[BGM_STATE] é”™è¯¯çŠ¶æ€ï¼Œå½“å‰state: ${this.bgmPlayer?.state}`);
        }
        
        // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ initialized çŠ¶æ€æ—¶è°ƒç”¨ prepare
        if (state === 'initialized') {
          console.log('[BGM_STATE] å·²åˆå§‹åŒ–ï¼Œå¼€å§‹å‡†å¤‡æ’­æ”¾');
          try {
            await this.bgmPlayer?.prepare();
            console.log('[BGM_STATE] prepare()å·²è°ƒç”¨');
          } catch (e) {
            console.error('[BGM_STATE] prepareå¤±è´¥:', e);
          }
        }
        
        if (state === 'prepared') {
          console.log('[BGM_STATE] å‡†å¤‡å®Œæˆï¼Œè®¾ç½®å¾ªç¯å¹¶å¼€å§‹æ’­æ”¾');
          try {
            // âœ… åœ¨ prepared çŠ¶æ€è®¾ç½®å¾ªç¯æ’­æ”¾
            if (this.bgmPlayer) {
              this.bgmPlayer.loop = true;
              console.log('[BGM_STATE] å¾ªç¯æ’­æ”¾å·²å¯ç”¨');
              
              // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ prepared çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ
              this.bgmPlayer.setVolume(this.bgmVolume);
              console.log(`[BGM_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: ${this.bgmVolume}`);
            }
            
            await this.bgmPlayer?.play();
            console.log('[BGM_STATE] æ’­æ”¾æŒ‡ä»¤å·²å‘é€');
          } catch (e) {
            console.error('[BGM_STATE] æ’­æ”¾å¤±è´¥:', e);
          }
        }
        
        if (state === 'playing') {
          console.log('[BGM_STATE] æ­£åœ¨æ’­æ”¾ä¸­ ğŸµ');
          // âœ… ä¿å­˜å½“å‰æ’­æ”¾çš„BGMè·¯å¾„
          this.currentBGMPath = resourcePath;
        }
      });

      this.bgmPlayer.on('error', (err: Error) => {
        console.error('[BGM_STATE] æ’­æ”¾é”™è¯¯:', err.message);
      });
      
      // ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ–¹å¼åŠ è½½èµ„æº
      const fd = await this.context.resourceManager.getRawFd(resourcePath);
      console.log(`[BGM_DEBUG] èµ„æºè·¯å¾„: ${resourcePath}`);
      console.log(`[BGM_DEBUG] æ–‡ä»¶æè¿°ç¬¦: fd=${fd.fd}, offset=${fd.offset}, length=${fd.length}`);
      console.log(`[BGM_DEBUG] fdæœ‰æ•ˆæ€§: ${fd.fd >= 0}`);
      
      if (fd.fd < 0) {
        console.error('[BGM_DEBUG] æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆï¼Œåœæ­¢æ’­æ”¾');
        return;
      }
      
      // ä¿å­˜fdå¼•ç”¨ä»¥ä¾¿åç»­å…³é—­
      this.currentBGMFd = fd;
      
      // âœ… è®¾ç½® fdSrcï¼Œè¿™ä¼šè§¦å‘å¼‚æ­¥çŠ¶æ€å˜åŒ–åˆ° initialized
      this.bgmPlayer.fdSrc = {
        fd: fd.fd,
        offset: fd.offset,
        length: fd.length
      };
      console.log('[BGM_DEBUG] fdSrcå·²è®¾ç½®ï¼Œè§¦å‘çŠ¶æ€å˜åŒ–åˆ°initialized...');
      console.log('[BGM_DEBUG] ç­‰å¾…çŠ¶æ€æœºè‡ªåŠ¨å¤„ç† initialized â†’ prepared â†’ playing');
      
      // âŒ ä¸è¦åœ¨è¿™é‡Œè°ƒç”¨ prepare()ï¼
      // AVPlayer çŠ¶æ€å˜åŒ–æ˜¯å¼‚æ­¥çš„ï¼Œå¿…é¡»åœ¨ stateChange çš„ 'initialized' äº‹ä»¶ä¸­è°ƒç”¨
      // prepare() å·²ç§»è‡³ stateChange çš„ 'initialized' åˆ†æ”¯
      // loop è®¾ç½®å·²ç§»è‡³ 'prepared' åˆ†æ”¯
    } catch (err) {
      let error = err as Error;
      console.error(`[BGM_DEBUG] æ’­æ”¾BGMå¤±è´¥: ${error.message}`, error);
    }
  }

  /**
   * æ’­æ”¾éŸ³æ•ˆ
   */
  async playSound(soundType: 'click' | 'flag' | 'win' | 'lose'): Promise<void> {
    if (!this.soundEnabled || !this.context) {
      console.log('[SOUND_DEBUG] Sound disabled or no context');
      return;
    }

    try {
      console.log(`[SOUND_DEBUG] å¼€å§‹æ’­æ”¾éŸ³æ•ˆ: ${soundType}`);
      
      // åœæ­¢ä¹‹å‰çš„éŸ³æ•ˆ
      if (this.soundPlayer) {
        try {
          await this.soundPlayer.stop();
          await this.soundPlayer.release();
          console.log('[SOUND_DEBUG] éŸ³æ•ˆæ’­æ”¾å™¨å·²é‡Šæ”¾');
        } catch (e) {
          console.log('[SOUND_DEBUG] Error stopping sound:', e);
        }
        this.soundPlayer = null;
        this.currentSoundFd = null;
      }

      this.soundPlayer = await media.createAVPlayer();
      console.log('[SOUND_DEBUG] AVPlayeråˆ›å»ºæˆåŠŸ');
      
      // âœ… è®¾ç½®åˆå§‹éŸ³é‡ï¼ˆä½¿ç”¨setVolumeæ–¹æ³•ï¼‰
      this.soundPlayer.setVolume(this.soundVolume);
      console.log(`[SOUND_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: ${this.soundVolume}`);
      
      // æ ¹æ®éŸ³æ•ˆç±»å‹è®¾ç½®èµ„æºè·¯å¾„
      let soundPath: string = '';
      switch (soundType) {
        case 'click':
          soundPath = 'music/Sound_Effects/ç¾Šå«å£°.mp3';
          break;
        case 'flag':
          soundPath = 'music/Sound_Effects/æ’æ——å£°.mp3';
          break;
        case 'win':
          soundPath = 'music/Sound_Effects/æ¬¢å‘¼å£°.mp3';
          break;
        case 'lose':
          soundPath = 'music/Sound_Effects/æ¸¸æˆå¤±è´¥.mp3';
          break;
      }
      
      console.log(`[SOUND_DEBUG] éŸ³æ•ˆç±»å‹: ${soundType}`);
      console.log(`[SOUND_DEBUG] èµ„æºè·¯å¾„: ${soundPath}`);
      
      // è®¾ç½®çŠ¶æ€å˜åŒ–ç›‘å¬å™¨ï¼ˆå¿…é¡»åœ¨è®¾ç½®fdSrcä¹‹å‰ï¼‰
      this.soundPlayer.on('stateChange', async (state: string) => {
        console.log(`[SOUND_STATE] ${soundType} çŠ¶æ€: ${state}`);
        
        if (state === 'error') {
          console.error(`[SOUND_STATE] é”™è¯¯çŠ¶æ€ï¼Œå½“å‰state: ${this.soundPlayer?.state}`);
        }
        
        // âœ… åœ¨ initialized çŠ¶æ€æ—¶è°ƒç”¨ prepare
        if (state === 'initialized') {
          console.log(`[SOUND_STATE] ${soundType} å·²åˆå§‹åŒ–ï¼Œå¼€å§‹å‡†å¤‡æ’­æ”¾`);
          try {
            await this.soundPlayer?.prepare();
            console.log(`[SOUND_STATE] ${soundType} prepare()å·²è°ƒç”¨`);
          } catch (e) {
            console.error(`[SOUND_STATE] ${soundType} prepareå¤±è´¥:`, e);
          }
        }
        
        if (state === 'prepared') {
          console.log(`[SOUND_STATE] å‡†å¤‡å®Œæˆï¼Œå¼€å§‹æ’­æ”¾ ${soundType}`);
          try {
            // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ prepared çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ
            if (this.soundPlayer) {
              this.soundPlayer.setVolume(this.soundVolume);
              console.log(`[SOUND_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: ${this.soundVolume}`);
            }
            await this.soundPlayer?.play();
            console.log(`[SOUND_STATE] ${soundType} æ’­æ”¾æŒ‡ä»¤å·²å‘é€`);
          } catch (e) {
            console.error(`[SOUND_STATE] ${soundType} æ’­æ”¾å¤±è´¥:`, e);
          }
        }
        
        if (state === 'playing') {
          console.log(`[SOUND_STATE] ${soundType} æ­£åœ¨æ’­æ”¾ä¸­ ğŸ”Š`);
        }
      });

      this.soundPlayer.on('error', (err: Error) => {
        console.error(`[SOUND_STATE] ${soundType} æ’­æ”¾é”™è¯¯:`, err.message);
      });
      
      // ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ–¹å¼åŠ è½½èµ„æº
      const fd = await this.context.resourceManager.getRawFd(soundPath);
      console.log(`[SOUND_DEBUG] æ–‡ä»¶æè¿°ç¬¦: fd=${fd.fd}, offset=${fd.offset}, length=${fd.length}`);
      console.log(`[SOUND_DEBUG] fdæœ‰æ•ˆæ€§: ${fd.fd >= 0}`);
      
      if (fd.fd < 0) {
        console.error('[SOUND_DEBUG] æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆ');
        return;
      }
      
      // ä¿å­˜fdå¼•ç”¨ä»¥ä¾¿åç»­å…³é—­
      this.currentSoundFd = fd;
      
      this.soundPlayer.fdSrc = {
        fd: fd.fd,
        offset: fd.offset,
        length: fd.length
      };
      console.log('[SOUND_DEBUG] fdSrcå·²è®¾ç½®ï¼Œè§¦å‘çŠ¶æ€å˜åŒ–åˆ°initialized...');
      console.log('[SOUND_DEBUG] ç­‰å¾…çŠ¶æ€æœºè‡ªåŠ¨å¤„ç† initialized â†’ prepared â†’ playing');
      // âŒ ä¸è¦åœ¨è¿™é‡Œè°ƒç”¨ prepare()ï¼ç”± stateChange ç›‘å¬å™¨è‡ªåŠ¨å¤„ç†
    } catch (err) {
      let error = err as Error;
      console.error(`[SOUND_DEBUG] æ’­æ”¾éŸ³æ•ˆå¤±è´¥: ${error.message}`, error);
    }
  }

  /**
   * åœæ­¢BGM
   */
  async stopBGM(): Promise<void> {
    if (this.bgmPlayer) {
      try {
        const state = this.bgmPlayer.state;
        console.log(`Stopping BGM, current state: ${state}`);
        
        if (state === 'playing' || state === 'paused') {
          await this.bgmPlayer.stop();
        }
        
        await this.bgmPlayer.release();
        this.bgmPlayer = null;
        this.currentBGMPath = ''; // æ¸…é™¤å½“å‰BGMè·¯å¾„
        console.log('BGM stopped and released');
      } catch (err) {
        console.error(`åœæ­¢BGMå¤±è´¥: ${err}`);
      }
    }
  }

  /**
   * è®¾ç½®BGMéŸ³é‡
   */
  setBGMVolume(volume: number): void {
    // é™åˆ¶éŸ³é‡èŒƒå›´åœ¨ 0.0-1.0 ä¹‹é—´
    this.bgmVolume = Math.max(0, Math.min(1, volume));
    console.log(`[VOLUME] è®¾ç½®BGMéŸ³é‡: ${this.bgmVolume}`);
    
    // âœ… å®é™…åº”ç”¨åˆ°AVPlayerï¼ˆä½¿ç”¨setVolumeæ–¹æ³•ï¼‰
    if (this.bgmPlayer) {
      try {
        this.bgmPlayer.setVolume(this.bgmVolume);
        console.log(`[VOLUME] BGMéŸ³é‡å·²åº”ç”¨åˆ°æ’­æ”¾å™¨: ${this.bgmVolume}`);
      } catch (err) {
        console.error(`[VOLUME] è®¾ç½®BGMéŸ³é‡å¤±è´¥:`, err);
      }
    } else {
      console.warn(`[VOLUME] BGMæ’­æ”¾å™¨æœªåˆå§‹åŒ–ï¼ŒéŸ³é‡å°†åœ¨ä¸‹æ¬¡æ’­æ”¾æ—¶åº”ç”¨`);
    }
    
    // âœ… ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
    this.saveVolumeSettings();
  }

  /**
   * è®¾ç½®éŸ³æ•ˆéŸ³é‡
   */
  setSoundVolume(volume: number): void {
    // é™åˆ¶éŸ³é‡èŒƒå›´åœ¨ 0.0-1.0 ä¹‹é—´
    this.soundVolume = Math.max(0, Math.min(1, volume));
    console.log(`[VOLUME] è®¾ç½®éŸ³æ•ˆéŸ³é‡: ${this.soundVolume}`);
    
    // âœ… å®é™…åº”ç”¨åˆ°AVPlayerï¼ˆä½¿ç”¨setVolumeæ–¹æ³•ï¼‰
    // éŸ³æ•ˆæ’­æ”¾å™¨åœ¨æ¯æ¬¡æ’­æ”¾æ—¶åˆ›å»ºï¼Œæ‰€ä»¥è¿™é‡Œä¿å­˜å€¼å³å¯ï¼Œåˆ›å»ºæ—¶ä¼šåº”ç”¨
    if (this.soundPlayer) {
      try {
        this.soundPlayer.setVolume(this.soundVolume);
        console.log(`[VOLUME] éŸ³æ•ˆéŸ³é‡å·²åº”ç”¨åˆ°æ’­æ”¾å™¨: ${this.soundVolume}`);
      } catch (err) {
        console.error(`[VOLUME] è®¾ç½®éŸ³æ•ˆéŸ³é‡å¤±è´¥:`, err);
      }
    }
    
    // âœ… ä¿å­˜åˆ°æŒä¹…åŒ–å­˜å‚¨
    this.saveVolumeSettings();
  }

  /**
   * å¯ç”¨/ç¦ç”¨BGM
   */
  setBGMEnabled(enabled: boolean): void {
    this.bgmEnabled = enabled;
    if (!enabled) {
      // è°ƒç”¨å¼‚æ­¥åœæ­¢BGMæ–¹æ³•ï¼ˆé”™è¯¯å·²åœ¨æ–¹æ³•å†…éƒ¨å¤„ç†ï¼‰
      this.stopBGMAsync();
    }
  }

  /**
   * å¼‚æ­¥åœæ­¢BGMï¼ˆç”¨äºé¿å…Promise.catchçš„unknownç±»å‹é—®é¢˜ï¼‰
   */
  private async stopBGMAsync(): Promise<void> {
    try {
      await this.stopBGM();
    } catch (error) {
      console.error('åœæ­¢BGMå¤±è´¥:', error);
    }
  }

  /**
   * å¯ç”¨/ç¦ç”¨éŸ³æ•ˆ
   */
  setSoundEnabled(enabled: boolean): void {
    this.soundEnabled = enabled;
  }

  /**
   * é‡Šæ”¾èµ„æº
   */
  async release(): Promise<void> {
    try {
      console.log('[RELEASE] é‡Šæ”¾éŸ³é¢‘èµ„æº');
      
      // æ¸…ç©ºBGM fdå¼•ç”¨
      this.currentBGMFd = null;
      
      await this.stopBGM();
      
      if (this.soundPlayer) {
        try {
          const state = this.soundPlayer.state;
          console.log(`[RELEASE] åœæ­¢éŸ³æ•ˆ, å½“å‰çŠ¶æ€: ${state}`);
          
          if (state === 'playing' || state === 'paused') {
            await this.soundPlayer.stop();
          }
          
          // æ¸…ç©ºéŸ³æ•ˆfdå¼•ç”¨
          this.currentSoundFd = null;
          
          await this.soundPlayer.release();
          this.soundPlayer = null;
          console.log('[RELEASE] éŸ³æ•ˆæ’­æ”¾å™¨å·²é‡Šæ”¾');
        } catch (e) {
          console.error('[RELEASE] é‡Šæ”¾éŸ³æ•ˆæ’­æ”¾å™¨å¤±è´¥:', e);
        }
      }
      
      console.log('[RELEASE] éŸ³é¢‘èµ„æºé‡Šæ”¾å®Œæˆ');
    } catch (err) {
      console.error(`[RELEASE] é‡Šæ”¾éŸ³é¢‘èµ„æºå¤±è´¥: ${err}`);
    }
  }
  
  /**
   * è·å–BGMå¯ç”¨çŠ¶æ€
   */
  isBGMEnabled(): boolean {
    return this.bgmEnabled;
  }
  
  /**
   * è·å–éŸ³æ•ˆå¯ç”¨çŠ¶æ€
   */
  isSoundEnabled(): boolean {
    return this.soundEnabled;
  }
}

export const audioManager = AudioManager.getInstance();
