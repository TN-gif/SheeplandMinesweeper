/**
 * éŸ³é¢‘ç®¡ç†å™¨ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
 * 
 * ç»Ÿä¸€ç®¡ç†åº”ç”¨ä¸­çš„æ‰€æœ‰éŸ³é¢‘æ’­æ”¾ï¼ŒåŒ…æ‹¬ï¼š
 * - èƒŒæ™¯éŸ³ä¹ï¼ˆBGMï¼‰çš„æ’­æ”¾ã€åˆ‡æ¢å’Œå¾ªç¯
 * - éŸ³æ•ˆï¼ˆç‚¹å‡»ã€æ’æ——ã€èƒœåˆ©ã€å¤±è´¥ï¼‰çš„æ’­æ”¾
 * - éŸ³é‡æ§åˆ¶å’ŒæŒä¹…åŒ–å­˜å‚¨
 * - èµ„æºçš„æ­£ç¡®åŠ è½½å’Œé‡Šæ”¾
 * 
 * è®¾è®¡è¦ç‚¹ï¼š
 * - ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¡®ä¿å…¨å±€å”¯ä¸€çš„éŸ³é¢‘ç®¡ç†å™¨
 * - BGMæ”¯æŒæ— ç¼åˆ‡æ¢å’Œå¾ªç¯æ’­æ”¾
 * - éŸ³é‡è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶æ¢å¤
 * - æ­£ç¡®å¤„ç†AVPlayerçŠ¶æ€æœºï¼Œé¿å…çŠ¶æ€é”™è¯¯
 */
import media from '@ohos.multimedia.media';
import common from '@ohos.app.ability.common';
import audio from '@ohos.multimedia.audio';
import resourceManager from '@ohos.resourceManager';
import preferences from '@ohos.data.preferences';

export class AudioManager {
  private static instance: AudioManager;
  
  /** BGMæ’­æ”¾å™¨å®ä¾‹ */
  private bgmPlayer: media.AVPlayer | null = null;
  
  /** éŸ³æ•ˆæ’­æ”¾å™¨å®ä¾‹ */
  private soundPlayer: media.AVPlayer | null = null;
  
  /** BGMéŸ³é‡ï¼ˆ0.0-1.0ï¼‰ï¼Œé»˜è®¤27% */
  private bgmVolume: number = 0.27;
  
  /** éŸ³æ•ˆéŸ³é‡ï¼ˆ0.0-1.0ï¼‰ï¼Œé»˜è®¤27% */
  private soundVolume: number = 0.27;
  
  /** BGMæ˜¯å¦å¯ç”¨ */
  private bgmEnabled: boolean = true;
  
  /** éŸ³æ•ˆæ˜¯å¦å¯ç”¨ */
  private soundEnabled: boolean = true;
  
  /** åº”ç”¨ä¸Šä¸‹æ–‡ï¼Œç”¨äºè®¿é—®èµ„æºç®¡ç†å™¨ */
  private context?: common.UIAbilityContext;
  
  /** å½“å‰BGMçš„æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨ */
  private currentBGMFd: resourceManager.RawFileDescriptor | null = null;
  
  /** å½“å‰éŸ³æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨ */
  private currentSoundFd: resourceManager.RawFileDescriptor | null = null;
  
  /** å½“å‰æ­£åœ¨æ’­æ”¾çš„BGMè·¯å¾„ï¼Œç”¨äºé¿å…é‡å¤æ’­æ”¾ */
  private currentBGMPath: string = '';
  
  /** æ•°æ®æŒä¹…åŒ–å­˜å‚¨å®ä¾‹ï¼Œç”¨äºä¿å­˜éŸ³é‡è®¾ç½® */
  private preferencesStore: preferences.Preferences | null = null;

  private constructor() {}

  /**
   * è·å–AudioManagerçš„å•ä¾‹å®ä¾‹
   * 
   * @returns {AudioManager} éŸ³é¢‘ç®¡ç†å™¨å®ä¾‹
   */
  static getInstance(): AudioManager {
    if (!AudioManager.instance) {
      AudioManager.instance = new AudioManager();
    }
    return AudioManager.instance;
  }

  /**
   * è®¾ç½®åº”ç”¨ä¸Šä¸‹æ–‡å¹¶åˆå§‹åŒ–éŸ³é¢‘ç³»ç»Ÿ
   * 
   * å¿…é¡»åœ¨ä½¿ç”¨éŸ³é¢‘åŠŸèƒ½å‰è°ƒç”¨æ­¤æ–¹æ³•ã€‚
   * ä¼šè‡ªåŠ¨åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„éŸ³é‡è®¾ç½®ã€‚
   * 
   * @param {common.UIAbilityContext} context - åº”ç”¨ä¸Šä¸‹æ–‡
   * @returns {Promise<void>} åˆå§‹åŒ–å®Œæˆçš„Promise
   */
  async setContext(context: common.UIAbilityContext): Promise<void> {
    this.context = context;
    // åˆå§‹åŒ–æ•°æ®æŒä¹…åŒ–å­˜å‚¨ï¼ŒåŠ è½½ä¸Šæ¬¡ä¿å­˜çš„éŸ³é‡è®¾ç½®
    await this.initPreferences();
  }

  /**
   * åˆå§‹åŒ–æ•°æ®æŒä¹…åŒ–å­˜å‚¨
   * 
   * åˆ›å»ºpreferenceså®ä¾‹å¹¶åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®ã€‚
   * å¦‚æœæ˜¯é¦–æ¬¡å¯åŠ¨ï¼Œä¼šä½¿ç”¨é»˜è®¤éŸ³é‡å€¼ã€‚
   */
  private async initPreferences(): Promise<void> {
    try {
      if (!this.context) {
        console.error('[PREFERENCES] Contextæœªè®¾ç½®');
        return;
      }
      
      // åˆ›å»ºæˆ–è·å– preferences å®ä¾‹
      this.preferencesStore = await preferences.getPreferences(this.context, 'audio_settings');
      console.log('[PREFERENCES] æ•°æ®å­˜å‚¨åˆå§‹åŒ–æˆåŠŸ');
      
      // åŠ è½½ä¿å­˜çš„éŸ³é‡è®¾ç½®
      await this.loadVolumeSettings();
    } catch (err) {
      console.error('[PREFERENCES] åˆå§‹åŒ–å¤±è´¥:', err);
    }
  }

  /**
   * ä»æœ¬åœ°å­˜å‚¨åŠ è½½éŸ³é‡è®¾ç½®
   * 
   * è¯»å–ä¸Šæ¬¡ä¿å­˜çš„BGMå’ŒéŸ³æ•ˆéŸ³é‡å€¼ã€‚
   * å¦‚æœæ²¡æœ‰ä¿å­˜çš„å€¼ï¼Œä½¿ç”¨é»˜è®¤å€¼0.27ã€‚
   * éŸ³é‡å€¼ä¼šè¢«é™åˆ¶åœ¨0.0-1.0èŒƒå›´å†…ã€‚
   */
  private async loadVolumeSettings(): Promise<void> {
    try {
      if (!this.preferencesStore) {
        console.warn('[PREFERENCES] å­˜å‚¨æœªåˆå§‹åŒ–');
        return;
      }
      
      // è¯»å–BGMéŸ³é‡
      const savedBgmVolume = await this.preferencesStore.get('bgm_volume', 0.27) as number;
      this.bgmVolume = Math.max(0, Math.min(1, savedBgmVolume));
      console.log(`[PREFERENCES] åŠ è½½BGMéŸ³é‡: ${this.bgmVolume}`);
      
      // è¯»å–éŸ³æ•ˆéŸ³é‡
      const savedSoundVolume = await this.preferencesStore.get('sound_volume', 0.27) as number;
      this.soundVolume = Math.max(0, Math.min(1, savedSoundVolume));
      console.log(`[PREFERENCES] åŠ è½½éŸ³æ•ˆéŸ³é‡: ${this.soundVolume}`);
    } catch (err) {
      console.error('[PREFERENCES] åŠ è½½éŸ³é‡è®¾ç½®å¤±è´¥:', err);
    }
  }

  /**
   * ä¿å­˜éŸ³é‡è®¾ç½®åˆ°æœ¬åœ°å­˜å‚¨
   * 
   * å°†å½“å‰çš„BGMå’ŒéŸ³æ•ˆéŸ³é‡æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚
   * ç¡®ä¿ç”¨æˆ·çš„éŸ³é‡åå¥½åœ¨åº”ç”¨é‡å¯åä¿æŒã€‚
   */
  private async saveVolumeSettings(): Promise<void> {
    try {
      if (!this.preferencesStore) {
        console.warn('[PREFERENCES] å­˜å‚¨æœªåˆå§‹åŒ–ï¼Œæ— æ³•ä¿å­˜');
        return;
      }
      
      // ä¿å­˜BGMéŸ³é‡
      await this.preferencesStore.put('bgm_volume', this.bgmVolume);
      await this.preferencesStore.put('sound_volume', this.soundVolume);
      
      // æŒä¹…åŒ–åˆ°ç£ç›˜
      await this.preferencesStore.flush();
      console.log(`[PREFERENCES] éŸ³é‡è®¾ç½®å·²ä¿å­˜: BGM=${this.bgmVolume}, Sound=${this.soundVolume}`);
    } catch (err) {
      console.error('[PREFERENCES] ä¿å­˜éŸ³é‡è®¾ç½®å¤±è´¥:', err);
    }
  }

  /**
   * è·å–å½“å‰BGMéŸ³é‡
   */
  getBGMVolume(): number {
    return this.bgmVolume;
  }

  /**
   * è·å–å½“å‰éŸ³æ•ˆéŸ³é‡
   */
  getSoundVolume(): number {
    return this.soundVolume;
  }

  /**
   * æ£€æµ‹éŸ³é¢‘è®¾å¤‡å¯ç”¨æ€§
   * 
   * ç®€åŒ–å®ç°ï¼Œä»…è¾“å‡ºæ—¥å¿—ã€‚
   * åŸå› ï¼šé¿å…ä½¿ç”¨å¯èƒ½ä¸ç¨³å®šçš„è®¾å¤‡æ£€æµ‹APIï¼Œä¾èµ–ç³»ç»Ÿè‡ªåŠ¨å¤„ç†ã€‚
   */
  checkAudioDevices(): void {
    console.log('[AUDIO_DEBUG] éŸ³é¢‘ç³»ç»Ÿåˆå§‹åŒ–ä¸­...');
  }

  /**
   * æ’­æ”¾èƒŒæ™¯éŸ³ä¹
   * 
   * æ™ºèƒ½åˆ‡æ¢BGMï¼Œé¿å…é‡å¤æ’­æ”¾ç›¸åŒéŸ³ä¹ã€‚
   * æ”¯æŒå¾ªç¯æ’­æ”¾å’ŒéŸ³é‡æ§åˆ¶ã€‚
   * 
   * æŠ€æœ¯è¦ç‚¹ï¼š
   * - ä½¿ç”¨AVPlayerçŠ¶æ€æœºæ­£ç¡®å¤„ç†å¼‚æ­¥çŠ¶æ€å˜åŒ–
   * - åœ¨initializedçŠ¶æ€è°ƒç”¨prepare()
   * - åœ¨preparedçŠ¶æ€è®¾ç½®å¾ªç¯å’Œå¼€å§‹æ’­æ”¾
   * - ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ–¹å¼åŠ è½½rawfileèµ„æº
   * 
   * @param {string} resourcePath - éŸ³ä¹æ–‡ä»¶åœ¨rawfileä¸­çš„ç›¸å¯¹è·¯å¾„
   * @returns {Promise<void>} æ’­æ”¾æ“ä½œå®Œæˆçš„Promise
   * 
   * @example
   * ```
   * await audioManager.playBGM('music/Background/ä¸»é¡µé¢èƒŒæ™¯éŸ³ä¹.mp3');
   * ```
   */
  async playBGM(resourcePath: string): Promise<void> {
    if (!this.bgmEnabled || !this.context) {
      console.log('[BGM_DEBUG] BGM disabled or no context');
      return;
    }

    try {
      console.log(`[BGM_DEBUG] å¼€å§‹æ’­æ”¾BGM: ${resourcePath}`);
      
      // âœ… æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨æ’­æ”¾åŒæ ·çš„BGM
      if (this.currentBGMPath === resourcePath && this.bgmPlayer && this.bgmPlayer.state === 'playing') {
        console.log('[BGM_DEBUG] å·²åœ¨æ’­æ”¾ç›¸åŒBGMï¼Œè·³è¿‡é‡å¤æ’­æ”¾');
        return;
      }
      
      // åœæ­¢å½“å‰BGMï¼ˆå¢åŠ çŠ¶æ€æ ¡éªŒï¼‰
      if (this.bgmPlayer) {
        try {
          const currentState = this.bgmPlayer.state;
          console.log(`[BGM_DEBUG] å½“å‰æ’­æ”¾å™¨çŠ¶æ€: ${currentState}`);
          
          // åªåœ¨æ’­æ”¾å™¨å¤„äºå¯åœæ­¢çŠ¶æ€æ—¶è°ƒç”¨ stop
          if (currentState === 'playing' || currentState === 'paused' || 
              currentState === 'prepared' || currentState === 'completed') {
            await this.bgmPlayer.stop();
            console.log('[BGM_DEBUG] æ’­æ”¾å™¨å·²åœæ­¢');
          }
          
          await this.bgmPlayer.release();
          console.log('[BGM_DEBUG] BGMæ’­æ”¾å™¨å·²é‡Šæ”¾');
        } catch (e) {
          console.log('[BGM_DEBUG] Error stopping BGM:', e);
        }
        this.bgmPlayer = null;
        this.currentBGMFd = null;
        this.currentBGMPath = ''; // æ¸…é™¤å½“å‰BGMè·¯å¾„
      }

      // åˆ›å»ºæ–°çš„æ’­æ”¾å™¨
      this.bgmPlayer = await media.createAVPlayer();
      console.log('[BGM_DEBUG] AVPlayeråˆ›å»ºæˆåŠŸ');
      
      // âœ… è®¾ç½®åˆå§‹éŸ³é‡ï¼ˆä½¿ç”¨setVolumeæ–¹æ³•ï¼‰
      this.bgmPlayer.setVolume(this.bgmVolume);
      console.log(`[BGM_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: ${this.bgmVolume}`);
      
      // è®¾ç½®çŠ¶æ€å˜åŒ–ç›‘å¬å™¨ï¼ˆå¿…é¡»åœ¨è®¾ç½®fdSrcä¹‹å‰ï¼‰
      this.bgmPlayer.on('stateChange', async (state: string) => {
        console.log(`[BGM_STATE] çŠ¶æ€å˜åŒ–: ${state}`);
        
        if (state === 'error') {
          console.error(`[BGM_STATE] é”™è¯¯çŠ¶æ€ï¼Œå½“å‰state: ${this.bgmPlayer?.state}`);
        }
        
        // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ initialized çŠ¶æ€æ—¶è°ƒç”¨ prepare
        if (state === 'initialized') {
          console.log('[BGM_STATE] å·²åˆå§‹åŒ–ï¼Œå¼€å§‹å‡†å¤‡æ’­æ”¾');
          try {
            await this.bgmPlayer?.prepare();
            console.log('[BGM_STATE] prepare()å·²è°ƒç”¨');
          } catch (e) {
            console.error('[BGM_STATE] prepareå¤±è´¥:', e);
          }
        }
        
        if (state === 'prepared') {
          console.log('[BGM_STATE] å‡†å¤‡å®Œæˆï¼Œè®¾ç½®å¾ªç¯å¹¶å¼€å§‹æ’­æ”¾');
          try {
            // âœ… åœ¨ prepared çŠ¶æ€è®¾ç½®å¾ªç¯æ’­æ”¾
            if (this.bgmPlayer) {
              this.bgmPlayer.loop = true;
              console.log('[BGM_STATE] å¾ªç¯æ’­æ”¾å·²å¯ç”¨');
              
              // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ prepared çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ
              this.bgmPlayer.setVolume(this.bgmVolume);
              console.log(`[BGM_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: ${this.bgmVolume}`);
            }
            
            await this.bgmPlayer?.play();
            console.log('[BGM_STATE] æ’­æ”¾æŒ‡ä»¤å·²å‘é€');
          } catch (e) {
            console.error('[BGM_STATE] æ’­æ”¾å¤±è´¥:', e);
          }
        }
        
        if (state === 'playing') {
          console.log('[BGM_STATE] æ­£åœ¨æ’­æ”¾ä¸­ ğŸµ');
          // âœ… ä¿å­˜å½“å‰æ’­æ”¾çš„BGMè·¯å¾„
          this.currentBGMPath = resourcePath;
        }
      });

      this.bgmPlayer.on('error', (err: Error) => {
        console.error('[BGM_STATE] æ’­æ”¾é”™è¯¯:', err.message);
      });
      
      // ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ–¹å¼åŠ è½½èµ„æº
      const fd = await this.context.resourceManager.getRawFd(resourcePath);
      console.log(`[BGM_DEBUG] èµ„æºè·¯å¾„: ${resourcePath}`);
      console.log(`[BGM_DEBUG] æ–‡ä»¶æè¿°ç¬¦: fd=${fd.fd}, offset=${fd.offset}, length=${fd.length}`);
      console.log(`[BGM_DEBUG] fdæœ‰æ•ˆæ€§: ${fd.fd >= 0}`);
      
      if (fd.fd < 0) {
        console.error('[BGM_DEBUG] æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆï¼Œåœæ­¢æ’­æ”¾');
        return;
      }
      
      // ä¿å­˜fdå¼•ç”¨ä»¥ä¾¿åç»­å…³é—­
      this.currentBGMFd = fd;
      
      // âœ… è®¾ç½® fdSrcï¼Œè¿™ä¼šè§¦å‘å¼‚æ­¥çŠ¶æ€å˜åŒ–åˆ° initialized
      this.bgmPlayer.fdSrc = {
        fd: fd.fd,
        offset: fd.offset,
        length: fd.length
      };
      console.log('[BGM_DEBUG] fdSrcå·²è®¾ç½®ï¼Œè§¦å‘çŠ¶æ€å˜åŒ–åˆ°initialized...');
      console.log('[BGM_DEBUG] ç­‰å¾…çŠ¶æ€æœºè‡ªåŠ¨å¤„ç† initialized â†’ prepared â†’ playing');
      
      // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè°ƒç”¨ prepare()
      // åŸå› ï¼šAVPlayerçŠ¶æ€å˜åŒ–æ˜¯å¼‚æ­¥çš„ï¼Œå¿…é¡»åœ¨stateChangeçš„'initialized'äº‹ä»¶ä¸­è°ƒç”¨
      // prepare()å·²ç§»è‡³stateChangeçš„'initialized'åˆ†æ”¯
      // loopè®¾ç½®å·²ç§»è‡³'prepared'åˆ†æ”¯
    } catch (err) {
      let error = err as Error;
      console.error(`[BGM_DEBUG] æ’­æ”¾BGMå¤±è´¥: ${error.message}`, error);
    }
  }

  /**
   * æ’­æ”¾éŸ³æ•ˆ
   * 
   * æ’­æ”¾çŸ­éŸ³æ•ˆï¼ˆç‚¹å‡»ã€æ’æ——ã€èƒœåˆ©ã€å¤±è´¥ï¼‰ã€‚
   * æ¯æ¬¡æ’­æ”¾ä¼šåˆ›å»ºæ–°çš„æ’­æ”¾å™¨å®ä¾‹ï¼Œæ”¯æŒå¿«é€Ÿè¿ç»­æ’­æ”¾ã€‚
   * 
   * @param {string} soundType - éŸ³æ•ˆç±»å‹ï¼š'click' | 'flag' | 'win' | 'lose'
   * @returns {Promise<void>} æ’­æ”¾æ“ä½œå®Œæˆçš„Promise
   * 
   * @example
   * ```
   * await audioManager.playSound('click'); // æ’­æ”¾ç‚¹å‡»éŸ³æ•ˆ
   * ```
   */
  async playSound(soundType: 'click' | 'flag' | 'win' | 'lose'): Promise<void> {
    if (!this.soundEnabled || !this.context) {
      console.log('[SOUND_DEBUG] Sound disabled or no context');
      return;
    }

    try {
      console.log(`[SOUND_DEBUG] å¼€å§‹æ’­æ”¾éŸ³æ•ˆ: ${soundType}`);
      
      // åœæ­¢ä¹‹å‰çš„éŸ³æ•ˆ
      if (this.soundPlayer) {
        try {
          await this.soundPlayer.stop();
          await this.soundPlayer.release();
          console.log('[SOUND_DEBUG] éŸ³æ•ˆæ’­æ”¾å™¨å·²é‡Šæ”¾');
        } catch (e) {
          console.log('[SOUND_DEBUG] Error stopping sound:', e);
        }
        this.soundPlayer = null;
        this.currentSoundFd = null;
      }

      this.soundPlayer = await media.createAVPlayer();
      console.log('[SOUND_DEBUG] AVPlayeråˆ›å»ºæˆåŠŸ');
      
      // âœ… è®¾ç½®åˆå§‹éŸ³é‡ï¼ˆä½¿ç”¨setVolumeæ–¹æ³•ï¼‰
      this.soundPlayer.setVolume(this.soundVolume);
      console.log(`[SOUND_DEBUG] åˆå§‹éŸ³é‡å·²è®¾ç½®: ${this.soundVolume}`);
      
      // æ ¹æ®éŸ³æ•ˆç±»å‹è®¾ç½®èµ„æºè·¯å¾„
      let soundPath: string = '';
      switch (soundType) {
        case 'click':
          soundPath = 'music/Sound_Effects/ç¾Šå«å£°.mp3';
          break;
        case 'flag':
          soundPath = 'music/Sound_Effects/æ’æ——å£°.mp3';
          break;
        case 'win':
          soundPath = 'music/Sound_Effects/æ¬¢å‘¼å£°.mp3';
          break;
        case 'lose':
          soundPath = 'music/Sound_Effects/æ¸¸æˆå¤±è´¥.mp3';
          break;
      }
      
      console.log(`[SOUND_DEBUG] éŸ³æ•ˆç±»å‹: ${soundType}`);
      console.log(`[SOUND_DEBUG] èµ„æºè·¯å¾„: ${soundPath}`);
      
      // è®¾ç½®çŠ¶æ€å˜åŒ–ç›‘å¬å™¨ï¼ˆå¿…é¡»åœ¨è®¾ç½®fdSrcä¹‹å‰ï¼‰
      this.soundPlayer.on('stateChange', async (state: string) => {
        console.log(`[SOUND_STATE] ${soundType} çŠ¶æ€: ${state}`);
        
        if (state === 'error') {
          console.error(`[SOUND_STATE] é”™è¯¯çŠ¶æ€ï¼Œå½“å‰state: ${this.soundPlayer?.state}`);
        }
        
        // âœ… åœ¨ initialized çŠ¶æ€æ—¶è°ƒç”¨ prepare
        if (state === 'initialized') {
          console.log(`[SOUND_STATE] ${soundType} å·²åˆå§‹åŒ–ï¼Œå¼€å§‹å‡†å¤‡æ’­æ”¾`);
          try {
            await this.soundPlayer?.prepare();
            console.log(`[SOUND_STATE] ${soundType} prepare()å·²è°ƒç”¨`);
          } catch (e) {
            console.error(`[SOUND_STATE] ${soundType} prepareå¤±è´¥:`, e);
          }
        }
        
        if (state === 'prepared') {
          console.log(`[SOUND_STATE] å‡†å¤‡å®Œæˆï¼Œå¼€å§‹æ’­æ”¾ ${soundType}`);
          try {
            // âœ… å…³é”®ä¿®å¤ï¼šåœ¨ prepared çŠ¶æ€å†æ¬¡è®¾ç½®éŸ³é‡ï¼Œç¡®ä¿ç”Ÿæ•ˆ
            if (this.soundPlayer) {
              this.soundPlayer.setVolume(this.soundVolume);
              console.log(`[SOUND_STATE] éŸ³é‡å·²åœ¨preparedçŠ¶æ€è®¾ç½®: ${this.soundVolume}`);
            }
            await this.soundPlayer?.play();
            console.log(`[SOUND_STATE] ${soundType} æ’­æ”¾æŒ‡ä»¤å·²å‘é€`);
          } catch (e) {
            console.error(`[SOUND_STATE] ${soundType} æ’­æ”¾å¤±è´¥:`, e);
          }
        }
        
        if (state === 'playing') {
          console.log(`[SOUND_STATE] ${soundType} æ­£åœ¨æ’­æ”¾ä¸­ ğŸ”Š`);
        }
      });

      this.soundPlayer.on('error', (err: Error) => {
        console.error(`[SOUND_STATE] ${soundType} æ’­æ”¾é”™è¯¯:`, err.message);
      });
      
      // ä½¿ç”¨æ–‡ä»¶æè¿°ç¬¦æ–¹å¼åŠ è½½èµ„æº
      const fd = await this.context.resourceManager.getRawFd(soundPath);
      console.log(`[SOUND_DEBUG] æ–‡ä»¶æè¿°ç¬¦: fd=${fd.fd}, offset=${fd.offset}, length=${fd.length}`);
      console.log(`[SOUND_DEBUG] fdæœ‰æ•ˆæ€§: ${fd.fd >= 0}`);
      
      if (fd.fd < 0) {
        console.error('[SOUND_DEBUG] æ–‡ä»¶æè¿°ç¬¦æ— æ•ˆ');
        return;
      }
      
      // ä¿å­˜fdå¼•ç”¨ä»¥ä¾¿åç»­å…³é—­
      this.currentSoundFd = fd;
      
      this.soundPlayer.fdSrc = {
        fd: fd.fd,
        offset: fd.offset,
        length: fd.length
      };
      console.log('[SOUND_DEBUG] fdSrcå·²è®¾ç½®ï¼Œè§¦å‘çŠ¶æ€å˜åŒ–åˆ°initialized...');
      console.log('[SOUND_DEBUG] ç­‰å¾…çŠ¶æ€æœºè‡ªåŠ¨å¤„ç† initialized â†’ prepared â†’ playing');
      // æ³¨æ„ï¼šä¸è¦åœ¨è¿™é‡Œè°ƒç”¨prepare()ï¼Œç”±stateChangeç›‘å¬å™¨è‡ªåŠ¨å¤„ç†
    } catch (err) {
      let error = err as Error;
      console.error(`[SOUND_DEBUG] æ’­æ”¾éŸ³æ•ˆå¤±è´¥: ${error.message}`, error);
    }
  }

  /**
   * åœæ­¢èƒŒæ™¯éŸ³ä¹
   * 
   * å®‰å…¨åœ°åœæ­¢å¹¶é‡Šæ”¾BGMæ’­æ”¾å™¨ã€‚
   * ä¼šæ ¹æ®æ’­æ”¾å™¨çŠ¶æ€é€‰æ‹©åˆé€‚çš„åœæ­¢æ–¹å¼ã€‚
   * 
   * @returns {Promise<void>} åœæ­¢æ“ä½œå®Œæˆçš„Promise
   */
  async stopBGM(): Promise<void> {
    if (this.bgmPlayer) {
      try {
        const state = this.bgmPlayer.state;
        console.log(`Stopping BGM, current state: ${state}`);
        
        if (state === 'playing' || state === 'paused') {
          await this.bgmPlayer.stop();
        }
        
        await this.bgmPlayer.release();
        this.bgmPlayer = null;
        this.currentBGMPath = ''; // æ¸…é™¤å½“å‰BGMè·¯å¾„
        console.log('BGM stopped and released');
      } catch (err) {
        console.error(`åœæ­¢BGMå¤±è´¥: ${err}`);
      }
    }
  }

  /**
   * è®¾ç½®BGMéŸ³é‡
   * 
   * åŠ¨æ€è°ƒæ•´èƒŒæ™¯éŸ³ä¹éŸ³é‡ï¼Œç«‹å³ç”Ÿæ•ˆå¹¶ä¿å­˜åˆ°æœ¬åœ°ã€‚
   * éŸ³é‡å€¼ä¼šè¢«é™åˆ¶åœ¨0.0-1.0èŒƒå›´å†…ã€‚
   * 
   * @param {number} volume - éŸ³é‡å€¼ï¼ˆ0.0-1.0ï¼‰
   */
  setBGMVolume(volume: number): void {
    // é™åˆ¶éŸ³é‡èŒƒå›´åœ¨0.0-1.0ä¹‹é—´
    this.bgmVolume = Math.max(0, Math.min(1, volume));
    console.log(`[VOLUME] è®¾ç½®BGMéŸ³é‡: ${this.bgmVolume}`);
    
    // å¦‚æœBGMæ­£åœ¨æ’­æ”¾ï¼Œç«‹å³åº”ç”¨æ–°éŸ³é‡
    if (this.bgmPlayer) {
      try {
        this.bgmPlayer.setVolume(this.bgmVolume);
        console.log(`[VOLUME] BGMéŸ³é‡å·²åº”ç”¨åˆ°æ’­æ”¾å™¨: ${this.bgmVolume}`);
      } catch (err) {
        console.error(`[VOLUME] è®¾ç½®BGMéŸ³é‡å¤±è´¥:`, err);
      }
    } else {
      console.warn(`[VOLUME] BGMæ’­æ”¾å™¨æœªåˆå§‹åŒ–ï¼ŒéŸ³é‡å°†åœ¨ä¸‹æ¬¡æ’­æ”¾æ—¶åº”ç”¨`);
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶æ¢å¤
    this.saveVolumeSettings();
  }

  /**
   * è®¾ç½®éŸ³æ•ˆéŸ³é‡
   * 
   * åŠ¨æ€è°ƒæ•´éŸ³æ•ˆéŸ³é‡ï¼Œç«‹å³ç”Ÿæ•ˆå¹¶ä¿å­˜åˆ°æœ¬åœ°ã€‚
   * éŸ³é‡å€¼ä¼šè¢«é™åˆ¶åœ¨0.0-1.0èŒƒå›´å†…ã€‚
   * 
   * @param {number} volume - éŸ³é‡å€¼ï¼ˆ0.0-1.0ï¼‰
   */
  setSoundVolume(volume: number): void {
    // é™åˆ¶éŸ³é‡èŒƒå›´åœ¨0.0-1.0ä¹‹é—´
    this.soundVolume = Math.max(0, Math.min(1, volume));
    console.log(`[VOLUME] è®¾ç½®éŸ³æ•ˆéŸ³é‡: ${this.soundVolume}`);
    
    // éŸ³æ•ˆæ’­æ”¾å™¨åœ¨æ¯æ¬¡æ’­æ”¾æ—¶åˆ›å»ºï¼Œæ‰€ä»¥è¿™é‡Œä¿å­˜å€¼å³å¯ï¼Œåˆ›å»ºæ—¶ä¼šåº”ç”¨
    if (this.soundPlayer) {
      try {
        this.soundPlayer.setVolume(this.soundVolume);
        console.log(`[VOLUME] éŸ³æ•ˆéŸ³é‡å·²åº”ç”¨åˆ°æ’­æ”¾å™¨: ${this.soundVolume}`);
      } catch (err) {
        console.error(`[VOLUME] è®¾ç½®éŸ³æ•ˆéŸ³é‡å¤±è´¥:`, err);
      }
    }
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶æ¢å¤
    this.saveVolumeSettings();
  }

  /**
   * å¯ç”¨æˆ–ç¦ç”¨BGMæ’­æ”¾
   * 
   * @param {boolean} enabled - true=å¯ç”¨ï¼Œfalse=ç¦ç”¨
   */
  setBGMEnabled(enabled: boolean): void {
    this.bgmEnabled = enabled;
    if (!enabled) {
      // ç¦ç”¨æ—¶ç«‹å³åœæ­¢BGMæ’­æ”¾
      this.stopBGMAsync();
    }
  }

  /**
   * å¼‚æ­¥åœæ­¢BGMçš„åŒ…è£…æ–¹æ³•
   * 
   * ç”¨äºåœ¨åŒæ­¥æ–¹æ³•ä¸­å®‰å…¨è°ƒç”¨å¼‚æ­¥åœæ­¢æ“ä½œã€‚
   */
  private async stopBGMAsync(): Promise<void> {
    try {
      await this.stopBGM();
    } catch (error) {
      console.error('åœæ­¢BGMå¤±è´¥:', error);
    }
  }

  /**
   * å¯ç”¨æˆ–ç¦ç”¨éŸ³æ•ˆæ’­æ”¾
   * 
   * @param {boolean} enabled - true=å¯ç”¨ï¼Œfalse=ç¦ç”¨
   */
  setSoundEnabled(enabled: boolean): void {
    this.soundEnabled = enabled;
  }

  /**
   * é‡Šæ”¾æ‰€æœ‰éŸ³é¢‘èµ„æº
   * 
   * åœæ­¢å¹¶é‡Šæ”¾BGMå’ŒéŸ³æ•ˆæ’­æ”¾å™¨ã€‚
   * åº”åœ¨åº”ç”¨é€€å‡ºæ—¶è°ƒç”¨ä»¥é¿å…èµ„æºæ³„æ¼ã€‚
   * 
   * @returns {Promise<void>} é‡Šæ”¾æ“ä½œå®Œæˆçš„Promise
   */
  async release(): Promise<void> {
    try {
      console.log('[RELEASE] é‡Šæ”¾éŸ³é¢‘èµ„æº');
      
      // æ¸…ç©ºBGM fdå¼•ç”¨
      this.currentBGMFd = null;
      
      await this.stopBGM();
      
      if (this.soundPlayer) {
        try {
          const state = this.soundPlayer.state;
          console.log(`[RELEASE] åœæ­¢éŸ³æ•ˆ, å½“å‰çŠ¶æ€: ${state}`);
          
          if (state === 'playing' || state === 'paused') {
            await this.soundPlayer.stop();
          }
          
          // æ¸…ç©ºéŸ³æ•ˆfdå¼•ç”¨
          this.currentSoundFd = null;
          
          await this.soundPlayer.release();
          this.soundPlayer = null;
          console.log('[RELEASE] éŸ³æ•ˆæ’­æ”¾å™¨å·²é‡Šæ”¾');
        } catch (e) {
          console.error('[RELEASE] é‡Šæ”¾éŸ³æ•ˆæ’­æ”¾å™¨å¤±è´¥:', e);
        }
      }
      
      console.log('[RELEASE] éŸ³é¢‘èµ„æºé‡Šæ”¾å®Œæˆ');
    } catch (err) {
      console.error(`[RELEASE] é‡Šæ”¾éŸ³é¢‘èµ„æºå¤±è´¥: ${err}`);
    }
  }
  
  /**
   * è·å–BGMå¯ç”¨çŠ¶æ€
   */
  isBGMEnabled(): boolean {
    return this.bgmEnabled;
  }
  
  /**
   * è·å–éŸ³æ•ˆå¯ç”¨çŠ¶æ€
   */
  isSoundEnabled(): boolean {
    return this.soundEnabled;
  }
}

export const audioManager = AudioManager.getInstance();
